"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.bundle = exports.bundleToFile = void 0;

var path = _interopRequireWildcard(require("path"));

var fs = _interopRequireWildcard(require("fs"));

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _config = require("./config");

var _traverse = _interopRequireDefault(require("./traverse"));

var _context = _interopRequireDefault(require("./context"));

var _OAS = require("./types/OAS3");

var _OAS2 = require("./types/OAS2");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function writeBundleToFile(bundleObject, outputFile) {
  const nameParts = outputFile.split('.');
  const ext = nameParts[nameParts.length - 1];
  const outputPath = path.resolve(outputFile);
  const outputDir = path.dirname(outputPath);
  fs.mkdirSync(outputDir, {
    recursive: true
  });
  let fileData = null;

  switch (ext) {
    case 'json':
      fileData = JSON.stringify(bundleObject, null, 2);
      break;

    case 'yaml':
    case 'yml':
    default:
      fileData = _jsYaml.default.safeDump(bundleObject);
      break;
  }

  fs.writeFileSync(`${outputPath}`, fileData);
}

const bundleToFile = async (fName, outputFile, force) => {
  const resolvedFileName = fName; // path.resolve(fName);

  const {
    document,
    source
  } = (0, _utils.readYaml)(resolvedFileName);

  if (!document.openapi && !document.swagger) {
    return [];
  }

  const lintConfig = (0, _config.getLintConfig)({});
  lintConfig.rules = { ...lintConfig.rules,
    bundler: { ...(lintConfig.rules && typeof lintConfig.rules.bundler === 'object' ? lintConfig.rules.bundler : null),
      output: outputFile,
      ignoreErrors: force
    }
  };
  const ctx = (0, _context.default)(document, source, resolvedFileName, lintConfig);
  const rootNode = ctx.openapiVersion === 3 ? _OAS.OpenAPIRoot : _OAS2.OAS2Root;
  await (0, _traverse.default)(document, rootNode, ctx);

  if (outputFile) {
    writeBundleToFile(ctx.bundlingResult, outputFile);
  } else {
    process.stdout.write(_jsYaml.default.safeDump(ctx.bundlingResult));
    process.stdout.write('\n');
  }

  return ctx.result;
};

exports.bundleToFile = bundleToFile;

const bundle = async (fName, force, options) => {
  const resolvedFileName = fName; // path.resolve(fName);

  const {
    document,
    source
  } = (0, _utils.readYaml)(resolvedFileName);

  if (!document.openapi && !document.swagger) {
    return [];
  }

  const config = (0, _config.getLintConfig)(options);
  config.rules = { ...config.rules,
    bundler: { ...(config.rules && typeof config.rules.bundler === 'object' ? config.rules.bundler : null),
      outputObject: true,
      ignoreErrors: force
    }
  };
  const ctx = (0, _context.default)(document, source, resolvedFileName, config);
  await (0, _traverse.default)(document, _OAS.OpenAPIRoot, ctx);
  return {
    bundle: ctx.bundlingResult,
    result: ctx.result,
    fileDependencies: ctx.fileDependencies
  };
};

exports.bundle = bundle;
var _default = bundleToFile;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9idW5kbGUuanMiXSwibmFtZXMiOlsid3JpdGVCdW5kbGVUb0ZpbGUiLCJidW5kbGVPYmplY3QiLCJvdXRwdXRGaWxlIiwibmFtZVBhcnRzIiwic3BsaXQiLCJleHQiLCJsZW5ndGgiLCJvdXRwdXRQYXRoIiwicGF0aCIsInJlc29sdmUiLCJvdXRwdXREaXIiLCJkaXJuYW1lIiwiZnMiLCJta2RpclN5bmMiLCJyZWN1cnNpdmUiLCJmaWxlRGF0YSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ5YW1sIiwic2FmZUR1bXAiLCJ3cml0ZUZpbGVTeW5jIiwiYnVuZGxlVG9GaWxlIiwiZk5hbWUiLCJmb3JjZSIsInJlc29sdmVkRmlsZU5hbWUiLCJkb2N1bWVudCIsInNvdXJjZSIsIm9wZW5hcGkiLCJzd2FnZ2VyIiwibGludENvbmZpZyIsInJ1bGVzIiwiYnVuZGxlciIsIm91dHB1dCIsImlnbm9yZUVycm9ycyIsImN0eCIsInJvb3ROb2RlIiwib3BlbmFwaVZlcnNpb24iLCJPcGVuQVBJUm9vdCIsIk9BUzJSb290IiwiYnVuZGxpbmdSZXN1bHQiLCJwcm9jZXNzIiwic3Rkb3V0Iiwid3JpdGUiLCJyZXN1bHQiLCJidW5kbGUiLCJvcHRpb25zIiwiY29uZmlnIiwib3V0cHV0T2JqZWN0IiwiZmlsZURlcGVuZGVuY2llcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUVBOzs7Ozs7OztBQUVBLFNBQVNBLGlCQUFULENBQTJCQyxZQUEzQixFQUF5Q0MsVUFBekMsRUFBcUQ7QUFDbkQsUUFBTUMsU0FBUyxHQUFHRCxVQUFVLENBQUNFLEtBQVgsQ0FBaUIsR0FBakIsQ0FBbEI7QUFDQSxRQUFNQyxHQUFHLEdBQUdGLFNBQVMsQ0FBQ0EsU0FBUyxDQUFDRyxNQUFWLEdBQW1CLENBQXBCLENBQXJCO0FBRUEsUUFBTUMsVUFBVSxHQUFHQyxJQUFJLENBQUNDLE9BQUwsQ0FBYVAsVUFB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RUFBUDtBQUFZOztBQUUxRCxRQUFNa0IsTUFBTSxHQUFHLDJCQUFjRCxPQUFkLENBQWY7QUFDQUMsRUFBQUEsTUFBTSxDQUFDaEIsS0FBUCxHQUFlLEVBQ2IsR0FBR2dCLE1BQU0sQ0FBQ2hCLEtBREc7QUFFYkMsSUFBQUEsT0FBTyxFQUFFLEVBQ1AsSUFBSWUsTUFBTSxDQUFDaEIsS0FBUCxJQUFnQixPQUFPZ0IsTUFBTSxDQUFDaEIsS0FBUCxDQUFhQyxPQUFwQixLQUFnQyxRQUFoRCxHQUEyRGUsTUFBTSxDQUFDaEIsS0FBUCxDQUFhQyxPQUF4RSxHQUFrRixJQUF0RixDQURPO0FBRVBnQixNQUFBQSxZQUFZLEVBQUUsSUFGUDtBQUdQZCxNQUFBQSxZQUFZLEVBQUVWO0FBSFA7QUFGSSxHQUFmO0FBU0EsUUFBTVcsR0FBRyxHQUFHLHNCQUFjVCxRQUFkLEVBQXdCQyxNQUF4QixFQUFnQ0YsZ0JBQWhDLEVBQWtEc0IsTUFBbEQsQ0FBWjtBQUVBLFFBQU0sdUJBQWFyQixRQUFiLEVBQXVCWSxnQkFBdkIsRUFBb0NILEdBQXBDLENBQU47QUFFQSxTQUFPO0FBQUVVLElBQUFBLE1BQU0sRUFBRVYsR0FBRyxDQUFDSyxjQUFkO0FBQThCSSxJQUFBQSxNQUFNLEVBQUVULEdBQUcsQ0FBQ1MsTUFBMUM7QUFBa0RLLElBQUFBLGdCQUFnQixFQUFFZCxHQUFHLENBQUNjO0FBQXhFLEdBQVA7QUFDRCxDQXJCTTs7O2VBdUJRM0IsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeWFtbCBmcm9tICdqcy15YW1sJztcblxuaW1wb3J0IHsgZ2V0TGludENvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB0cmF2ZXJzZU5vZGUgZnJvbSAnLi90cmF2ZXJzZSc7XG5pbXBvcnQgY3JlYXRlQ29udGV4dCBmcm9tICcuL2NvbnRleHQnO1xuXG5pbXBvcnQgeyBPcGVuQVBJUm9vdCB9IGZyb20gJy4vdHlwZXMvT0FTMyc7XG5pbXBvcnQgeyBPQVMyUm9vdCB9IGZyb20gJy4vdHlwZXMvT0FTMic7XG5cbmltcG9ydCB7IHJlYWRZYW1sIH0gZnJvbSAnLi91dGlscyc7XG5cbmZ1bmN0aW9uIHdyaXRlQnVuZGxlVG9GaWxlKGJ1bmRsZU9iamVjdCwgb3V0cHV0RmlsZSkge1xuICBjb25zdCBuYW1lUGFydHMgPSBvdXRwdXRGaWxlLnNwbGl0KCcuJyk7XG4gIGNvbnN0IGV4dCA9IG5hbWVQYXJ0c1tuYW1lUGFydHMubGVuZ3RoIC0gMV07XG5cbiAgY29uc3Qgb3V0cHV0UGF0aCA9IHBhdGgucmVzb2x2ZShvdXRwdXRGaWxlKTtcblxuICBjb25zdCBvdXRwdXREaXIgPSBwYXRoLmRpcm5hbWUob3V0cHV0UGF0aCk7XG4gIGZzLm1rZGlyU3luYyhvdXRwdXREaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXG4gIGxldCBmaWxlRGF0YSA9IG51bGw7XG5cbiAgc3dpdGNoIChleHQpIHtcbiAgICBjYXNlICdqc29uJzpcbiAgICAgIGZpbGVEYXRhID0gSlNPTi5zdHJpbmdpZnkoYnVuZGxlT2JqZWN0LCBudWxsLCAyKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3lhbWwnOlxuICAgIGNhc2UgJ3ltbCc6XG4gICAgZGVmYXVsdDpcbiAgICAgIGZpbGVEYXRhID0geWFtbC5zYWZlRHVtcChidW5kbGVPYmplY3QpO1xuICAgICAgYnJlYWs7XG4gIH1cbiAgZnMud3JpdGVGaWxlU3luYyhgJHtvdXRwdXRQYXRofWAsIGZpbGVEYXRhKTtcbn1cblxuZXhwb3J0IGNvbnN0IGJ1bmRsZVRvRmlsZSA9IGFzeW5jIChmTmFtZSwgb3V0cHV0RmlsZSwgZm9yY2UpID0+IHtcbiAgY29uc3QgcmVzb2x2ZWRGaWxlTmFtZSA9IGZOYW1lOyAvLyBwYXRoLnJlc29sdmUoZk5hbWUpO1xuICBjb25zdCB7IGRvY3VtZW50LCBzb3VyY2UgfSA9IHJlYWRZYW1sKHJlc29sdmVkRmlsZU5hbWUpO1xuXG4gIGlmICghZG9jdW1lbnQub3BlbmFwaSAmJiAhZG9jdW1lbnQuc3dhZ2dlcikgeyByZXR1cm4gW107IH1cblxuICBjb25zdCBsaW50Q29uZmlnID0gZ2V0TGludENvbmZpZyh7fSk7XG4gIGxpbnRDb25maWcucnVsZXMgPSB7XG4gICAgLi4ubGludENvbmZpZy5ydWxlcyxcbiAgICBidW5kbGVyOiB7XG4gICAgICAuLi4obGludENvbmZpZy5ydWxlcyAmJiB0eXBlb2YgbGludENvbmZpZy5ydWxlcy5idW5kbGVyID09PSAnb2JqZWN0JyA/IGxpbnRDb25maWcucnVsZXMuYnVuZGxlciA6IG51bGwpLFxuICAgICAgb3V0cHV0OiBvdXRwdXRGaWxlLFxuICAgICAgaWdub3JlRXJyb3JzOiBmb3JjZSxcbiAgICB9LFxuICB9O1xuXG4gIGNvbnN0IGN0eCA9IGNyZWF0ZUNvbnRleHQoZG9jdW1lbnQsIHNvdXJjZSwgcmVzb2x2ZWRGaWxlTmFtZSwgbGludENvbmZpZyk7XG5cbiAgY29uc3Qgcm9vdE5vZGUgPSBjdHgub3BlbmFwaVZlcnNpb24gPT09IDMgPyBPcGVuQVBJUm9vdCA6IE9BUzJSb290O1xuICBhd2FpdCB0cmF2ZXJzZU5vZGUoZG9jdW1lbnQsIHJvb3ROb2RlLCBjdHgpO1xuXG4gIGlmIChvdXRwdXRGaWxlKSB7XG4gICAgd3JpdGVCdW5kbGVUb0ZpbGUoY3R4LmJ1bmRsaW5nUmVzdWx0LCBvdXRwdXRGaWxlKTtcbiAgfSBlbHNlIHtcbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSh5YW1sLnNhZmVEdW1wKGN0eC5idW5kbGluZ1Jlc3VsdCkpO1xuICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKCdcXG4nKTtcbiAgfVxuXG4gIHJldHVybiBjdHgucmVzdWx0O1xufTtcblxuZXhwb3J0IGNvbnN0IGJ1bmRsZSA9IGFzeW5jIChmTmFtZSwgZm9yY2UsIG9wdGlvbnMpID0+IHtcbiAgY29uc3QgcmVzb2x2ZWRGaWxlTmFtZSA9IGZOYW1lOyAvLyBwYXRoLnJlc29sdmUoZk5hbWUpO1xuICBjb25zdCB7IGRvY3VtZW50LCBzb3VyY2UgfSA9IHJlYWRZYW1sKHJlc29sdmVkRmlsZU5hbWUpO1xuXG4gIGlmICghZG9jdW1lbnQub3BlbmFwaSAmJiAhZG9jdW1lbnQuc3dhZ2dlcikgeyByZXR1cm4gW107IH1cblxuICBjb25zdCBjb25maWcgPSBnZXRMaW50Q29uZmlnKG9wdGlvbnMpO1xuICBjb25maWcucnVsZXMgPSB7XG4gICAgLi4uY29uZmlnLnJ1bGVzLFxuICAgIGJ1bmRsZXI6IHtcbiAgICAgIC4uLihjb25maWcucnVsZXMgJiYgdHlwZW9mIGNvbmZpZy5ydWxlcy5idW5kbGVyID09PSAnb2JqZWN0JyA/IGNvbmZpZy5ydWxlcy5idW5kbGVyIDogbnVsbCksXG4gICAgICBvdXRwdXRPYmplY3Q6IHRydWUsXG4gICAgICBpZ25vcmVFcnJvcnM6IGZvcmNlLFxuICAgIH0sXG4gIH07XG5cbiAgY29uc3QgY3R4ID0gY3JlYXRlQ29udGV4dChkb2N1bWVudCwgc291cmNlLCByZXNvbHZlZEZpbGVOYW1lLCBjb25maWcpO1xuXG4gIGF3YWl0IHRyYXZlcnNlTm9kZShkb2N1bWVudCwgT3BlbkFQSVJvb3QsIGN0eCk7XG5cbiAgcmV0dXJuIHsgYnVuZGxlOiBjdHguYnVuZGxpbmdSZXN1bHQsIHJlc3VsdDogY3R4LnJlc3VsdCwgZmlsZURlcGVuZGVuY2llczogY3R4LmZpbGVEZXBlbmRlbmNpZXMgfTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGJ1bmRsZVRvRmlsZTtcbiJdfQ==