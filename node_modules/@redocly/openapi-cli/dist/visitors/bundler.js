"use strict";

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash.isequal"));

var _default = require("../error/default");

var _OpenAPISchema = _interopRequireDefault(require("../types/OAS3/OpenAPISchema"));

var _OpenAPIDiscriminator = require("../types/OAS3/OpenAPIDiscriminator");

var _utils = require("../utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-case-declarations */

/* eslint-disable no-param-reassign */

/* eslint-disable class-methods-use-this */
const getComponentName = (refString, components, componentType, node, ctx) => {
  const errors = [];
  refString = refString.replace('#/', '/');

  const itemNameBase = _path.default.basename(refString, _path.default.extname(refString));

  const pathParts = _path.default.dirname(refString).split('/');

  const componentsGroup = components[componentType];
  if (!componentsGroup) return {
    name: itemNameBase,
    errors
  };
  let name = itemNameBase;
  let i = pathParts.length - 1;

  while (componentsGroup[name] && !(0, _lodash.default)(componentsGroup[name], node) && i >= 0) {
    const prevName = name;
    name = `${pathParts[i]}_${itemNameBase}`;
    errors.push(ctx.createError(`Two schemas are referenced with the same name but different content. Renamed ${prevName} to ${name}`, 'key'));
    i--;
  }

  if (i >= 0) return {
    name,
    errors
  };
  let serialId = 0;

  while (componentsGroup[name] && !(0, _lodash.default)(componentsGroup[name], node)) {
    serialId++;
    name = `${name}-${serialId}`;
  }

  return {
    name,
    errors
  };
};

class Bundler {
  constructor(config) {
    this.config = config;
    this.nameConflictsEnabled = this.config.nameConflicts !== 'off';

    if (this.nameConflictsEnabled) {
      this.nameConflictsSeverity = (0, _default.getMsgLevelFromString)(this.config.nameConflicts || '');
    }

    this.components = {};
    this.oas2components = {};
    this.newRefNodes = new Map();
  }

  static get rule() {
    return 'bundler';
  }

  defNameToType(definitionName) {
    switch (definitionName) {
      case 'OpenAPISchema':
        return 'schemas';

      case 'OpenAPIParameter':
        return 'parameters';

      case 'OpenAPIResponse':
        return 'responses';

      case 'OpenAPIExample':
        return 'examples';

      case 'OpenAPIRequestBody':
        return 'requestBodies';

      case 'OpenAPIHeader':
        return 'headers';

      case 'OpenAPISecuritySchema':
        return 'securitySchemes';

      case 'OpenAPILink':
        return 'links';

      case 'OpenAPICallback':
        return 'callbacks';

      case 'OAS2Schema':
        return 'definitions';

      case 'OAS2Response':
        return 'responses';

      case 'OAS2Parameter':
        return 'parameters';

      default:
        return null;
    }
  }

  includeImplicitDiscriminator(pointer, schemas, ctx, {
    traverseNode,
    visited
  }) {
    const $ref = `#/${pointer.join('/')}`;
    const errors = [];

    for (const [name, schema] of Object.entries(schemas || {})) {
      if (schema.allOf && schema.allOf.find(s => s.$ref === $ref)) {
        const existingSchema = this.components.schemas && this.components.schemas[name];

        if (existingSchema && !(0, _lodash.default)(existingSchema, schema)) {
          errors.push(ctx.createError(`Implicitly mapped discriminator schema "${name}" conflicts with existing schema. Skipping.`, 'key'));
        }

        this.components.schemas = this.components.schemas || {};
        this.components.schemas[name] = schema;
        ctx.pathStack.push({
          path: ctx.path,
          file: ctx.filePath,
          document: ctx.document,
          source: ctx.source
        });
        ctx.path = ['components', 'schemas', name];
        traverseNode(schema, _OpenAPISchema.default, ctx, visited);
        ctx.path = ctx.pathStack.pop().path;
      }
    }

    return errors;
  }

  saveComponent(ctx, node, name, componentType) {
    let ref;

    if (ctx.openapiVersion === 3) {
      ref = `#/components/${componentType}/${name}`;

      if (!this.components[componentType]) {
        this.components[componentType] = {};
      }

      this.components[componentType][name] = node;
    } else {
      switch (componentType) {
        case 'definitions':
          ref = `#/definitions/${name}`;
          break;

        case 'parameters':
          ref = `#/parameters/${name}`;
          break;

        case 'responses':
          ref = `#/responses/${name}`;
          break;

        default:
          return null;
      }

      if (!this.oas2components[componentType]) {
        this.oas2components[componentType] = {};
      }

      this.oas2components[componentType][name] = node;
    }

    return ref;
  }

  any() {
    return {
      onExit: (node, definition, ctx, unresolvedNode, {
        traverseNode,
        visited
      }) => {
        let errors = [];

        if (ctx.openapiVersion === 3 && node.discriminator && !node.oneOf && !node.anyOf && !node.mapping) {
          errors = this.includeImplicitDiscriminator(ctx.path, ctx.document.components && ctx.document.components.schemas, ctx, {
            traverseNode,
            visited
          });
        }

        if (unresolvedNode && node !== unresolvedNode && (0, _utils.isRef)(unresolvedNode)) {
          const componentType = this.defNameToType(definition.name);

          if (!componentType) {
            delete unresolvedNode.$ref;
            Object.assign(unresolvedNode, node);
          } else if (!this.newRefNodes.has(unresolvedNode)) {
            const {
              name,
              errors: nameErrors
            } = getComponentName(unresolvedNode.$ref, this.components, componentType, node, ctx);
            errors.push(...nameErrors);
            const newRef = this.saveComponent(ctx, node, name, componentType);

            if (!newRef) {
              delete unresolvedNode.$ref;
              Object.assign(unresolvedNode, node);
              return errors;
            } // we can't replace nodes in-place as non-idempotent
            // nodes will be visited again and will fail bundling
            // so we save it and replace at the end


            this.newRefNodes.set(unresolvedNode, newRef);
          }
        }

        errors.forEach(e => {
          e.severity = this.nameConflictsSeverity;
        });

        if (!this.nameConflictsEnabled) {
          errors = [];
        }

        return errors;
      }
    };
  }

  OAS2Root() {
    return {
      onExit: (node, definition, ctx) => {
        if (!this.config.ignoreErrors && ctx.result.some(e => e.severity === _default.messageLevels.ERROR)) {
          ctx.bundlingResult = null;
          return null;
        }

        for (const [unresolvedNode, newRef] of this.newRefNodes.entries()) {
          unresolvedNode.$ref = newRef;
        }

        Object.keys(this.oas2components).forEach(component => {
          node[component] = node[component] ? node[component] : {};
          Object.assign(node[component], this.oas2components[component]);
        });
        ctx.bundlingResult = node;
        return null;
      }
    };
  }

  OpenAPIRoot() {
    return {
      onExit: (node, definition, ctx) => {
        if (!node.components) {
          node.components = {};
        }

        if (!this.config.ignoreErrors && ctx.result.some(e => e.severity === _default.messageLevels.ERROR)) {
          ctx.bundlingResult = null;
          return null;
        }

        for (const [unresolvedNode, newRef] of this.newRefNodes.entries()) {
          if (unresolvedNode[_OpenAPIDiscriminator.MAPPING_DATA_KEY]) {
            // FIXME: too hack
            const {
              mapping,
              key
            } = unresolvedNode[_OpenAPIDiscriminator.MAPPING_DATA_KEY];
            mapping[key] = newRef;
          } else {
            unresolvedNode.$ref = newRef;
          }
        }

        Object.keys(this.components).forEach(component => {
          node.components[component] = node.components[component] ? node.components[component] : {};
          Object.assign(node.components[component], this.components[component]);
        });
        ctx.bundlingResult = node;
        return null;
      }
    };
  }

}

module.exports = Bundler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aXNpdG9ycy9idW5kbGVyLmpzIl0sIm5hbWVzIjpbImdldENvbXBvbmVudE5hbWUiLCJyZWZTdHJpbmciLCJjb21wb25lbnRzIiwiY29tcG9uZW50VHlwZSIsIm5vZGUiLCJjdHgiLCJlcnJvcnMiLCJyZXBsYWNlIiwiaXRlbU5hbWVCYXNlIiwicGF0aCIsImJhc2VuYW1lIiwiZXh0bmFtZSIsInBhdGhQYXJ0cyIsImRpcm5hbWUiLCJzcGxpdCIsImNvbXBvbmVudHNHcm91cCIsIm5hbWUiLCJpIiwibGVuZ3RoIiwicHJldk5hbWUiLCJwdXNoIiwiY3JlYXRlRXJyb3IiLCJzZXJpYWxJZCIsIkJ1bmRsZXIiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsIm5hbWVDb25mbGljdHNFbmFibGVkIiwibmFtZUNvbmZsaWN0cyIsIm5hbWVDb25mbGljdHNTZXZlcml0eSIsIm9hczJjb21wb25lbnRzIiwibmV3UmVmTm9kZXMiLCJNYXAiLCJydWxlIiwiZGVmTmFtZVRvVHlwZSIsImRlZmluaXRpb25OYW1lIiwiaW5jbHVkZUltcGxpY2l0RGlzY3JpbWluYXRvciIsInBvaW50ZXIiLCJzY2hlbWFzIiwidHJhdmVyc2VOb2RlIiwidmlzaXRlZCIsIiRyZWYiLCJqb2luIiwic2NoZW1hIiwiT2JqZWN0IiwiZW50cmllcyIsImFsbE9mIiwiZmluZCIsInMiLCJleGlzdGluZ1NjaGVtYSIsInBhdGhTdGFjayIsImZpbGUiLCJmaWxlUGF0aCIsImRvY3VtZW50Iiwic291cmNlIiwiT3BlbkFQSVNjaGVtYU9iamVjdCIsInBvcCIsInNhdmVDb21wb25lbnQiLCJyZWYiLCJvcGVuYXBpVmVyc2lvbiIsImFueSIsIm9uRXhpdCIsImRlZmluaXRpb24iLCJ1bnJlc29sdmVkTm9kZSIsImRpc2NyaW1pbmF0b3IiLCJvbmVPZiIsImFueU9mIiwibWFwcGluZyIsImFzc2lnbiIsImhhcyIsIm5hbWVFcnJvcnMiLCJuZXdSZWYiLCJzZXQiLCJmb3JFYWNoIiwiZSIsInNldmVyaXR5IiwiT0FTMlJvb3QiLCJpZ25vcmVFcnJvcnMiLCJyZXN1bHQiLCJzb21lIiwibWVzc2FnZUxldmVscyIsIkVSUk9SIiwiYnVuZGxpbmdSZXN1bHQiLCJrZXlzIiwiY29tcG9uZW50IiwiT3BlbkFQSVJvb3QiLCJNQVBQSU5HX0RBVEFfS0VZIiwia2V5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFHQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQVRBOztBQUNBOztBQUNBO0FBU0EsTUFBTUEsZ0JBQWdCLEdBQUcsQ0FBQ0MsU0FBRCxFQUFZQyxVQUFaLEVBQXdCQyxhQUF4QixFQUF1Q0MsSUFBdkMsRUFBNkNDLEdBQTdDLEtBQXFEO0FBQzVFLFFBQU1DLE1BQU0sR0FBRyxFQUFmO0FBRUFMLEVBQUFBLFNBQVMsR0FBR0EsU0FBUyxDQUFDTSxPQUFWLENBQWtCLElBQWxCLEVBQXdCLEdBQXhCLENBQVo7O0FBQ0EsUUFBTUMsWUFBWSxHQUFHQyxjQUFLQyxRQUFMLENBQWNULFNBQWQsRUFBeUJRLGNBQUtFLE9BQUwsQ0FBYVYsU0FBYixDQUF6QixDQUFyQjs7QUFDQSxRQUFNVyxTQUFTLEdBQUdILGNBQUtJLE9BQUwsQ0FBYVosU0FBYixFQUF3QmEsS0FBeEIsQ0FBOEIsR0FBOUIsQ0FBbEI7O0FBRUEsUUFBTUMsZUFBZSxHQUFHYixVQUFVLENBQUNDLGFBQUQsQ0FBbEM7QUFDQSxNQUFJLENBQUNZLGVBQUwsRUFBc0IsT0FBTztBQUFFQyxJQUFBQSxJQUFJLEVBQUVSLFlBQVI7QUFBc0JGLElBQUFBO0FBQXRCLEdBQVA7QUFFdEIsTUFBSVUsSUFBSSxHQUFHUixZQUFYO0FBQ0EsTUFBSVMsQ0FBQyxHQUFHTCxTQUFTLENBQUNNLE1BQVYsR0FBbUIsQ0FBM0I7O0FBRUEsU0FBT0gsZUFBZSxDQUFDQyxJQUFELENBQWYsSUFBeUIsQ0FBQyxxQkFBUUQsZUFBZSxDQUFDQyxJQUFELENBQXZCLEVBQStCWixJQUEvQixDQUExQixJQUFrRWEsQ0FBQyxJQUFJLENBQTlFLEVBQWlGO0FBQy9FLFVBQU1FLFFBQVEsR0FBR0gsSUFBakI7QUFDQUEsSUFBQUEsSUFBSSxHQUFJLEdBQUVKLFNBQVMsQ0FBQ0ssQ0FBRCxDQUFJLElBQUdULFlBQWEsRUFBdkM7QUFFQUYsSUFBQUEsTUFBTSxDQUFDYyxJQUFQLENBQ0VmLEdBQUcsQ0FBQ2dCLFdBQUosQ0FDRyxnRkFBK0VGLFFBQVMsT0FBTUgsSUFBSyxFQUR0RyxFQUVFLEtBRkYsQ0FERjtBQU1BQyxJQUFBQSxDQUFDO0FBQ0Y7O0FBRUQsTUFBSUEsQ0FBQyxJQUFJLENBQVQsRUFBWSxPQUFPO0FBQUVELElBQUFBLElBQUY7QUFBUVYsSUFBQUE7QUFBUixHQUFQO0FBRVosTUFBSWdCLFFBQVEsR0FBRyxDQUFmOztBQUNBLFNBQU9QLGVBQWUsQ0FBQ0MsSUFBRCxDQUFmLElBQXlCLENBQUMscUJBQVFELGVBQWUsQ0FBQ0MsSUFBRCxDQUF2QixFQUErQlosSUFBL0IsQ0FBakMsRUFBdUU7QUFDckVrQixJQUFBQSxRQUFRO0FBQ1JOLElBQUFBLElBQUksR0FBSSxHQUFFQSxJQUFLLElBQUdNLFFBQVMsRUFBM0I7QUFDRDs7QUFFRCxTQUFPO0FBQUVOLElBQUFBLElBQUY7QUFBUVYsSUFBQUE7QUFBUixHQUFQO0FBQ0QsQ0FuQ0Q7O0FBcUNBLE1BQU1pQixPQUFOLENBQWM7QUFDWkMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQVM7QUFDbEIsU0FBS0EsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0Msb0JBQUwsR0FBNEIsS0FBS0QsTUFBTCxDQUFZRSxhQUFaLEtBQThCLEtBQTFEOztBQUNBLFFBQUksS0FBS0Qsb0JBQVQsRUFBK0I7QUFDN0IsV0FBS0UscUJBQUwsR0FBNkIsb0NBQXNCLEtBQUtILE1BQUwsQ0FBWUUsYUFBWixJQUE2QixFQUFuRCxDQUE3QjtBQUNEOztBQUNELFNBQUt6QixVQUFMLEdBQWtCLEVBQWxCO0FBQ0EsU0FBSzJCLGNBQUwsR0FBc0IsRUFBdEI7QUFFQSxTQUFLQyxXQUFMLEdBQW1CLElBQUlDLEdBQUosRUFBbkI7QUFDRDs7QUFFRCxhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8sU0FBUDtBQUNEOztBQUVEQyxFQUFBQSxhQUFhLENBQUNDLGNBQUQsRUFBaUI7QUFDNUIsWUFBUUEsY0FBUjtBQUNFLFdBQUssZUFBTDtBQUNFLGVBQU8sU0FBUDs7QUFDRixXQUFLLGtCQUFMO0FBQ0UsZUFBTyxZQUFQOztBQUNGLFdBQUssaUJBQUw7QUFDRSxlQUFPLFdBQVA7O0FBQ0YsV0FBSyxnQkFBTDtBQUNFLGVBQU8sVUFBUDs7QUFDRixXQUFLLG9CQUFMO0FBQ0UsZUFBTyxlQUFQOztBQUNGLFdBQUssZUFBTDtBQUNFLGVBQU8sU0FBUDs7QUFDRixXQUFLLHVCQUFMO0FBQ0UsZUFBTyxpQkFBUDs7QUFDRixXQUFLLGFBQUw7QUFDRSxlQUFPLE9BQVA7O0FBQ0YsV0FBSyxpQkFBTDtBQUNFLGVBQU8sV0FBUDs7QUFDRixXQUFLLFlBQUw7QUFDRSxlQUFPLGFBQVA7O0FBQ0YsV0FBSyxjQUFMO0FBQ0UsZUFBTyxXQUFQOztBQUNGLFdBQUssZUFBTDtBQUNFLGVBQU8sWUFBUDs7QUFDRjtBQUNFLGVBQU8sSUFBUDtBQTFCSjtBQTRCRDs7QUFFREMsRUFBQUEsNEJBQTRCLENBQUNDLE9BQUQsRUFBVUMsT0FBVixFQUFtQmhDLEdBQW5CLEVBQXdCO0FBQUVpQyxJQUFBQSxZQUFGO0FBQWdCQyxJQUFBQTtBQUFoQixHQUF4QixFQUFtRDtBQUM3RSxVQUFNQyxJQUFJLEdBQUksS0FBSUosT0FBTyxDQUFDSyxJQUFSLENBQWEsR0FBYixDQUFrQixFQUFwQztBQUNBLFVBQU1uQyxNQUFNLEdBQUcsRUFBZjs7QUFFQSxTQUFLLE1BQU0sQ0FBQ1UsSUFBRCxFQUFPMEIsTUFBUCxDQUFYLElBQTZCQyxNQUFNLENBQUNDLE9BQVAsQ0FBZVAsT0FBTyxJQUFJLEVBQTFCLENBQTdCLEVBQTREO0FBQzFELFVBQUlLLE1BQU0sQ0FBQ0csS0FBUCxJQUFnQkgsTUFBTSxDQUFDRyxLQUFQLENBQWFDLElBQWIsQ0FBbUJDLENBQUQsSUFBT0EsQ0FBQyxDQUFDUCxJQUFGLEtBQVdBLElBQXBDLENBQXBCLEVBQStEO0FBQzdELGNBQU1RLGNBQWMsR0FBRyxLQUFLOUMsVUFBTCxDQUFnQm1DLE9BQWhCLElBQTJCLEtBQUtuQyxVQUFMLENBQWdCbUMsT0FBaEIsQ0FBd0JyQixJQUF4QixDQUFsRDs7QUFDQSxZQUFJZ0MsY0FBYyxJQUFJLENBQUMscUJBQVFBLGNBQVIsRUFBd0JOLE1BQXhCLENBQXZCLEVBQXdEO0FBQ3REcEMsVUFBQUEsTUFBTSxDQUFDYyxJQUFQLENBQVlmLEdBQUcsQ0FBQ2dCLFdBQUosQ0FDVCwyQ0FBMENMLElBQUssNkNBRHRDLEVBQ29GLEtBRHBGLENBQVo7QUFHRDs7QUFFRCxhQUFLZCxVQUFMLENBQWdCbUMsT0FBaEIsR0FBMEIsS0FBS25DLFVBQUwsQ0FBZ0JtQyxPQUFoQixJQUEyQixFQUFyRDtBQUNBLGFBQUtuQyxVQUFMLENBQWdCbUMsT0FBaEIsQ0FBd0JyQixJQUF4QixJQUFnQzBCLE1BQWhDO0FBRUFyQyxRQUFBQSxHQUFHLENBQUM0QyxTQUFKLENBQWM3QixJQUFkLENBQW1CO0FBQ2pCWCxVQUFBQSxJQUFJLEVBQUVKLEdBQUcsQ0FBQ0ksSUFETztBQUVqQnlDLFVBQUFBLElBQUksRUFBRTdDLEdBQUcsQ0FBQzhDLFFBRk87QUFHakJDLFVBQUFBLFFBQVEsRUFBRS9DLEdBQUcsQ0FBQytDLFFBSEc7QUFJakJDLFVBQUFBLE1BQU0sRUFBRWhELEdBQUcsQ0FBQ2dEO0FBSkssU0FBbkI7QUFPQWhELFFBQUFBLEdBQUcsQ0FBQ0ksSUFBSixHQUFXLENBQUMsWUFBRCxFQUFlLFNBQWYsRUFBMEJPLElBQTFCLENBQVg7QUFDQXNCLFFBQUFBLFlBQVksQ0FBQ0ksTUFBRCxFQUFTWSxzQkFBVCxFQUE4QmpELEdBQTlCLEVBQW1Da0MsT0FBbkMsQ0FBWjtBQUNBbEMsUUFBQUEsR0FBRyxDQUFDSSxJQUFKLEdBQVdKLEdBQUcsQ0FBQzRDLFNBQUosQ0FBY00sR0FBZCxHQUFvQjlDLElBQS9CO0FBQ0Q7QUFDRjs7QUFFRCxXQUFPSCxNQUFQO0FBQ0Q7O0FBRURrRCxFQUFBQSxhQUFhLENBQUNuRCxHQUFELEVBQU1ELElBQU4sRUFBWVksSUFBWixFQUFrQmIsYUFBbEIsRUFBaUM7QUFDNUMsUUFBSXNELEdBQUo7O0FBQ0EsUUFBSXBELEdBQUcsQ0FBQ3FELGNBQUosS0FBdUIsQ0FBM0IsRUFBOEI7QUFDNUJELE1BQUFBLEdBQUcsR0FBSSxnQkFBZXRELGFBQWMsSUFBR2EsSUFBSyxFQUE1Qzs7QUFFQSxVQUFJLENBQUMsS0FBS2QsVUFBTCxDQUFnQkMsYUFBaEIsQ0FBTCxFQUFxQztBQUNuQyxhQUFLRCxVQUFMLENBQWdCQyxhQUFoQixJQUFpQyxFQUFqQztBQUNEOztBQUVELFdBQUtELFVBQUwsQ0FBZ0JDLGFBQWhCLEVBQStCYSxJQUEvQixJQUF1Q1osSUFBdkM7QUFDRCxLQVJELE1BUU87QUFDTCxjQUFRRCxhQUFSO0FBQ0UsYUFBSyxhQUFMO0FBQ0VzRCxVQUFBQSxHQUFHLEdBQUksaUJBQWdCekMsSUFBSyxFQUE1QjtBQUNBOztBQUNGLGFBQUssWUFBTDtBQUNFeUMsVUFBQUEsR0FBRyxHQUFJLGdCQUFlekMsSUFBSyxFQUEzQjtBQUNBOztBQUNGLGFBQUssV0FBTDtBQUNFeUMsVUFBQUEsR0FBRyxHQUFJLGVBQWN6QyxJQUFLLEVBQTFCO0FBQ0E7O0FBQ0Y7QUFDRSxpQkFBTyxJQUFQO0FBWEo7O0FBY0EsVUFBSSxDQUFDLEtBQUthLGNBQUwsQ0FBb0IxQixhQUFwQixDQUFMLEVBQXlDO0FBQ3ZDLGFBQUswQixjQUFMLENBQW9CMUIsYUFBcEIsSUFBcUMsRUFBckM7QUFDRDs7QUFDRCxXQUFLMEIsY0FBTCxDQUFvQjFCLGFBQXBCLEVBQW1DYSxJQUFuQyxJQUEyQ1osSUFBM0M7QUFDRDs7QUFDRCxXQUFPcUQsR0FBUDtBQUNEOztBQUVERSxFQUFBQSxHQUFHLEdBQUc7QUFDSixXQUFPO0FBQ0xDLE1BQUFBLE1BQU0sRUFBRSxDQUFDeEQsSUFBRCxFQUFPeUQsVUFBUCxFQUFtQnhELEdBQW5CLEVBQXdCeUQsY0FBeEIsRUFBd0M7QUFBRXhCLFFBQUFBLFlBQUY7QUFBZ0JDLFFBQUFBO0FBQWhCLE9BQXhDLEtBQXNFO0FBQzVFLFlBQUlqQyxNQUFNLEdBQUcsRUFBYjs7QUFFQSxZQUFJRCxHQUFHLENBQUNxRCxjQUFKLEtBQXVCLENBQXZCLElBQ0N0RCxJQUFJLENBQUMyRCxhQUROLElBRUMsQ0FBQzNELElBQUksQ0FBQzRELEtBRlAsSUFHQyxDQUFDNUQsSUFBSSxDQUFDNkQsS0FIUCxJQUlDLENBQUM3RCxJQUFJLENBQUM4RCxPQUpYLEVBSW9CO0FBQ2xCNUQsVUFBQUEsTUFBTSxHQUFHLEtBQUs2Qiw0QkFBTCxDQUNQOUIsR0FBRyxDQUFDSSxJQURHLEVBRVBKLEdBQUcsQ0FBQytDLFFBQUosQ0FBYWxELFVBQWIsSUFBMkJHLEdBQUcsQ0FBQytDLFFBQUosQ0FBYWxELFVBQWIsQ0FBd0JtQyxPQUY1QyxFQUdQaEMsR0FITyxFQUlQO0FBQUVpQyxZQUFBQSxZQUFGO0FBQWdCQyxZQUFBQTtBQUFoQixXQUpPLENBQVQ7QUFNRDs7QUFFRCxZQUFJdUIsY0FBYyxJQUFJMUQsSUFBSSxLQUFLMEQsY0FBM0IsSUFBNkMsa0JBQU1BLGNBQU4sQ0FBakQsRUFBd0U7QUFDdEUsZ0JBQU0zRCxhQUFhLEdBQUcsS0FBSzhCLGFBQUwsQ0FBbUI0QixVQUFVLENBQUM3QyxJQUE5QixDQUF0Qjs7QUFFQSxjQUFJLENBQUNiLGFBQUwsRUFBb0I7QUFDbEIsbUJBQU8yRCxjQUFjLENBQUN0QixJQUF0QjtBQUNBRyxZQUFBQSxNQUFNLENBQUN3QixNQUFQLENBQWNMLGNBQWQsRUFBOEIxRCxJQUE5QjtBQUNELFdBSEQsTUFHTyxJQUFJLENBQUMsS0FBSzBCLFdBQUwsQ0FBaUJzQyxHQUFqQixDQUFxQk4sY0FBckIsQ0FBTCxFQUEyQztBQUNoRCxrQkFBTTtBQUFFOUMsY0FBQUEsSUFBRjtBQUFRVixjQUFBQSxNQUFNLEVBQUUrRDtBQUFoQixnQkFBK0JyRSxnQkFBZ0IsQ0FDbkQ4RCxjQUFjLENBQUN0QixJQURvQyxFQUM5QixLQUFLdEMsVUFEeUIsRUFDYkMsYUFEYSxFQUNFQyxJQURGLEVBQ1FDLEdBRFIsQ0FBckQ7QUFJQUMsWUFBQUEsTUFBTSxDQUFDYyxJQUFQLENBQVksR0FBR2lELFVBQWY7QUFFQSxrQkFBTUMsTUFBTSxHQUFHLEtBQUtkLGFBQUwsQ0FBbUJuRCxHQUFuQixFQUF3QkQsSUFBeEIsRUFBOEJZLElBQTlCLEVBQW9DYixhQUFwQyxDQUFmOztBQUNBLGdCQUFJLENBQUNtRSxNQUFMLEVBQWE7QUFDWCxxQkFBT1IsY0FBYyxDQUFDdEIsSUFBdEI7QUFDQUcsY0FBQUEsTUFBTSxDQUFDd0IsTUFBUCxDQUFjTCxjQUFkLEVBQThCMUQsSUFBOUI7QUFDQSxxQkFBT0UsTUFBUDtBQUNELGFBWitDLENBY2hEO0FBQ0E7QUFDQTs7O0FBQ0EsaUJBQUt3QixXQUFMLENBQWlCeUMsR0FBakIsQ0FBcUJULGNBQXJCLEVBQXFDUSxNQUFyQztBQUNEO0FBQ0Y7O0FBRURoRSxRQUFBQSxNQUFNLENBQUNrRSxPQUFQLENBQWdCQyxDQUFELElBQU87QUFDcEJBLFVBQUFBLENBQUMsQ0FBQ0MsUUFBRixHQUFhLEtBQUs5QyxxQkFBbEI7QUFDRCxTQUZEOztBQUlBLFlBQUksQ0FBQyxLQUFLRixvQkFBVixFQUFnQztBQUM5QnBCLFVBQUFBLE1BQU0sR0FBRyxFQUFUO0FBQ0Q7O0FBRUQsZUFBT0EsTUFBUDtBQUNEO0FBckRJLEtBQVA7QUF1REQ7O0FBRURxRSxFQUFBQSxRQUFRLEdBQUc7QUFDVCxXQUFPO0FBQ0xmLE1BQUFBLE1BQU0sRUFBRSxDQUFDeEQsSUFBRCxFQUFPeUQsVUFBUCxFQUFtQnhELEdBQW5CLEtBQTJCO0FBQ2pDLFlBQUksQ0FBQyxLQUFLb0IsTUFBTCxDQUFZbUQsWUFBYixJQUE2QnZFLEdBQUcsQ0FBQ3dFLE1BQUosQ0FBV0MsSUFBWCxDQUFpQkwsQ0FBRCxJQUFPQSxDQUFDLENBQUNDLFFBQUYsS0FBZUssdUJBQWNDLEtBQXBELENBQWpDLEVBQTZGO0FBQzNGM0UsVUFBQUEsR0FBRyxDQUFDNEUsY0FBSixHQUFxQixJQUFyQjtBQUNBLGlCQUFPLElBQVA7QUFDRDs7QUFFRCxhQUFLLE1BQU0sQ0FBQ25CLGNBQUQsRUFBaUJRLE1BQWpCLENBQVgsSUFBdUMsS0FBS3hDLFdBQUwsQ0FBaUJjLE9BQWpCLEVBQXZDLEVBQW1FO0FBQ2pFa0IsVUFBQUEsY0FBYyxDQUFDdEIsSUFBZixHQUFzQjhCLE1BQXRCO0FBQ0Q7O0FBRUQzQixRQUFBQSxNQUFNLENBQUN1QyxJQUFQLENBQVksS0FBS3JELGNBQWpCLEVBQWlDMkMsT0FBakMsQ0FBMENXLFNBQUQsSUFBZTtBQUN0RC9FLFVBQUFBLElBQUksQ0FBQytFLFNBQUQsQ0FBSixHQUFrQi9FLElBQUksQ0FBQytFLFNBQUQsQ0FBSixHQUFrQi9FLElBQUksQ0FBQytFLFNBQUQsQ0FBdEIsR0FBb0MsRUFBdEQ7QUFDQXhDLFVBQUFBLE1BQU0sQ0FBQ3dCLE1BQVAsQ0FBYy9ELElBQUksQ0FBQytFLFNBQUQsQ0FBbEIsRUFBK0IsS0FBS3RELGNBQUwsQ0FBb0JzRCxTQUFwQixDQUEvQjtBQUNELFNBSEQ7QUFLQTlFLFFBQUFBLEdBQUcsQ0FBQzRFLGNBQUosR0FBcUI3RSxJQUFyQjtBQUNBLGVBQU8sSUFBUDtBQUNEO0FBbEJJLEtBQVA7QUFvQkQ7O0FBRURnRixFQUFBQSxXQUFXLEdBQUc7QUFDWixXQUFPO0FBQ0x4QixNQUFBQSxNQUFNLEVBQUUsQ0FBQ3hELElBQUQsRUFBT3lELFVBQVAsRUFBbUJ4RCxHQUFuQixLQUEyQjtBQUNqQyxZQUFJLENBQUNELElBQUksQ0FBQ0YsVUFBVixFQUFzQjtBQUNwQkUsVUFBQUEsSUFBSSxDQUFDRixVQUFMLEdBQWtCLEVBQWxCO0FBQ0Q7O0FBRUQsWUFBSSxDQUFDLEtBQUt1QixNQUFMLENBQVltRCxZQUFiLElBQTZCdkUsR0FBRyxDQUFDd0UsTUFBSixDQUFXQyxJQUFYLENBQWlCTCxDQUFELElBQU9BLENBQUMsQ0FBQ0MsUUFBRixLQUFlSyx1QkFBY0MsS0FBcEQsQ0FBakMsRUFBNkY7QUFDM0YzRSxVQUFBQSxHQUFHLENBQUM0RSxjQUFKLEdBQXFCLElBQXJCO0FBQ0EsaUJBQU8sSUFBUDtBQUNEOztBQUVELGFBQUssTUFBTSxDQUFDbkIsY0FBRCxFQUFpQlEsTUFBakIsQ0FBWCxJQUF1QyxLQUFLeEMsV0FBTCxDQUFpQmMsT0FBakIsRUFBdkMsRUFBbUU7QUFDakUsY0FBSWtCLGNBQWMsQ0FBQ3VCLHNDQUFELENBQWxCLEVBQXNDO0FBQUU7QUFDdEMsa0JBQU07QUFBRW5CLGNBQUFBLE9BQUY7QUFBV29CLGNBQUFBO0FBQVgsZ0JBQW1CeEIsY0FBYyxDQUFDdUIsc0NBQUQsQ0FBdkM7QUFDQW5CLFlBQUFBLE9BQU8sQ0FBQ29CLEdBQUQsQ0FBUCxHQUFlaEIsTUFBZjtBQUNELFdBSEQsTUFHTztBQUNMUixZQUFBQSxjQUFjLENBQUN0QixJQUFmLEdBQXNCOEIsTUFBdEI7QUFDRDtBQUNGOztBQUVEM0IsUUFBQUEsTUFBTSxDQUFDdUMsSUFBUCxDQUFZLEtBQUtoRixVQUFqQixFQUE2QnNFLE9BQTdCLENBQXNDVyxTQUFELElBQWU7QUFDbEQvRSxVQUFBQSxJQUFJLENBQUNGLFVBQUwsQ0FBZ0JpRixTQUFoQixJQUE2Qi9FLElBQUksQ0FBQ0YsVUFBTCxDQUFnQmlGLFNBQWhCLElBQTZCL0UsSUFBSSxDQUFDRixVQUFMLENBQWdCaUYsU0FBaEIsQ0FBN0IsR0FBMEQsRUFBdkY7QUFDQXhDLFVBQUFBLE1BQU0sQ0FBQ3dCLE1BQVAsQ0FBYy9ELElBQUksQ0FBQ0YsVUFBTCxDQUFnQmlGLFNBQWhCLENBQWQsRUFBMEMsS0FBS2pGLFVBQUwsQ0FBZ0JpRixTQUFoQixDQUExQztBQUNELFNBSEQ7QUFLQTlFLFFBQUFBLEdBQUcsQ0FBQzRFLGNBQUosR0FBcUI3RSxJQUFyQjtBQUNBLGVBQU8sSUFBUDtBQUNEO0FBM0JJLEtBQVA7QUE2QkQ7O0FBaE9XOztBQW1PZG1GLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpFLE9BQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tY2FzZS1kZWNsYXJhdGlvbnMgKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLXBhcmFtLXJlYXNzaWduICovXG4vKiBlc2xpbnQtZGlzYWJsZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzICovXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBpc0VxdWFsIGZyb20gJ2xvZGFzaC5pc2VxdWFsJztcblxuaW1wb3J0IHsgZ2V0TXNnTGV2ZWxGcm9tU3RyaW5nLCBtZXNzYWdlTGV2ZWxzIH0gZnJvbSAnLi4vZXJyb3IvZGVmYXVsdCc7XG5pbXBvcnQgT3BlbkFQSVNjaGVtYU9iamVjdCBmcm9tICcuLi90eXBlcy9PQVMzL09wZW5BUElTY2hlbWEnO1xuaW1wb3J0IHsgTUFQUElOR19EQVRBX0tFWSB9IGZyb20gJy4uL3R5cGVzL09BUzMvT3BlbkFQSURpc2NyaW1pbmF0b3InO1xuaW1wb3J0IHsgaXNSZWYgfSBmcm9tICcuLi91dGlscyc7XG5cbmNvbnN0IGdldENvbXBvbmVudE5hbWUgPSAocmVmU3RyaW5nLCBjb21wb25lbnRzLCBjb21wb25lbnRUeXBlLCBub2RlLCBjdHgpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgcmVmU3RyaW5nID0gcmVmU3RyaW5nLnJlcGxhY2UoJyMvJywgJy8nKTtcbiAgY29uc3QgaXRlbU5hbWVCYXNlID0gcGF0aC5iYXNlbmFtZShyZWZTdHJpbmcsIHBhdGguZXh0bmFtZShyZWZTdHJpbmcpKTtcbiAgY29uc3QgcGF0aFBhcnRzID0gcGF0aC5kaXJuYW1lKHJlZlN0cmluZykuc3BsaXQoJy8nKTtcblxuICBjb25zdCBjb21wb25lbnRzR3JvdXAgPSBjb21wb25lbnRzW2NvbXBvbmVudFR5cGVdO1xuICBpZiAoIWNvbXBvbmVudHNHcm91cCkgcmV0dXJuIHsgbmFtZTogaXRlbU5hbWVCYXNlLCBlcnJvcnMgfTtcblxuICBsZXQgbmFtZSA9IGl0ZW1OYW1lQmFzZTtcbiAgbGV0IGkgPSBwYXRoUGFydHMubGVuZ3RoIC0gMTtcblxuICB3aGlsZSAoY29tcG9uZW50c0dyb3VwW25hbWVdICYmICFpc0VxdWFsKGNvbXBvbmVudHNHcm91cFtuYW1lXSwgbm9kZSkgJiYgaSA+PSAwKSB7XG4gICAgY29uc3QgcHJldk5hbWUgPSBuYW1lO1xuICAgIG5hbWUgPSBgJHtwYXRoUGFydHNbaV19XyR7aXRlbU5hbWVCYXNlfWA7XG5cbiAgICBlcnJvcnMucHVzaChcbiAgICAgIGN0eC5jcmVhdGVFcnJvcihcbiAgICAgICAgYFR3byBzY2hlbWFzIGFyZSByZWZlcmVuY2VkIHdpdGggdGhlIHNhbWUgbmFtZSBidXQgZGlmZmVyZW50IGNvbnRlbnQuIFJlbmFtZWQgJHtwcmV2TmFtZX0gdG8gJHtuYW1lfWAsXG4gICAgICAgICdrZXknLFxuICAgICAgKSxcbiAgICApO1xuICAgIGktLTtcbiAgfVxuXG4gIGlmIChpID49IDApIHJldHVybiB7IG5hbWUsIGVycm9ycyB9O1xuXG4gIGxldCBzZXJpYWxJZCA9IDA7XG4gIHdoaWxlIChjb21wb25lbnRzR3JvdXBbbmFtZV0gJiYgIWlzRXF1YWwoY29tcG9uZW50c0dyb3VwW25hbWVdLCBub2RlKSkge1xuICAgIHNlcmlhbElkKys7XG4gICAgbmFtZSA9IGAke25hbWV9LSR7c2VyaWFsSWR9YDtcbiAgfVxuXG4gIHJldHVybiB7IG5hbWUsIGVycm9ycyB9O1xufTtcblxuY2xhc3MgQnVuZGxlciB7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMubmFtZUNvbmZsaWN0c0VuYWJsZWQgPSB0aGlzLmNvbmZpZy5uYW1lQ29uZmxpY3RzICE9PSAnb2ZmJztcbiAgICBpZiAodGhpcy5uYW1lQ29uZmxpY3RzRW5hYmxlZCkge1xuICAgICAgdGhpcy5uYW1lQ29uZmxpY3RzU2V2ZXJpdHkgPSBnZXRNc2dMZXZlbEZyb21TdHJpbmcodGhpcy5jb25maWcubmFtZUNvbmZsaWN0cyB8fCAnJyk7XG4gICAgfVxuICAgIHRoaXMuY29tcG9uZW50cyA9IHt9O1xuICAgIHRoaXMub2FzMmNvbXBvbmVudHMgPSB7fTtcblxuICAgIHRoaXMubmV3UmVmTm9kZXMgPSBuZXcgTWFwKCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0IHJ1bGUoKSB7XG4gICAgcmV0dXJuICdidW5kbGVyJztcbiAgfVxuXG4gIGRlZk5hbWVUb1R5cGUoZGVmaW5pdGlvbk5hbWUpIHtcbiAgICBzd2l0Y2ggKGRlZmluaXRpb25OYW1lKSB7XG4gICAgICBjYXNlICdPcGVuQVBJU2NoZW1hJzpcbiAgICAgICAgcmV0dXJuICdzY2hlbWFzJztcbiAgICAgIGNhc2UgJ09wZW5BUElQYXJhbWV0ZXInOlxuICAgICAgICByZXR1cm4gJ3BhcmFtZXRlcnMnO1xuICAgICAgY2FzZSAnT3BlbkFQSVJlc3BvbnNlJzpcbiAgICAgICAgcmV0dXJuICdyZXNwb25zZXMnO1xuICAgICAgY2FzZSAnT3BlbkFQSUV4YW1wbGUnOlxuICAgICAgICByZXR1cm4gJ2V4YW1wbGVzJztcbiAgICAgIGNhc2UgJ09wZW5BUElSZXF1ZXN0Qm9keSc6XG4gICAgICAgIHJldHVybiAncmVxdWVzdEJvZGllcyc7XG4gICAgICBjYXNlICdPcGVuQVBJSGVhZGVyJzpcbiAgICAgICAgcmV0dXJuICdoZWFkZXJzJztcbiAgICAgIGNhc2UgJ09wZW5BUElTZWN1cml0eVNjaGVtYSc6XG4gICAgICAgIHJldHVybiAnc2VjdXJpdHlTY2hlbWVzJztcbiAgICAgIGNhc2UgJ09wZW5BUElMaW5rJzpcbiAgICAgICAgcmV0dXJuICdsaW5rcyc7XG4gICAgICBjYXNlICdPcGVuQVBJQ2FsbGJhY2snOlxuICAgICAgICByZXR1cm4gJ2NhbGxiYWNrcyc7XG4gICAgICBjYXNlICdPQVMyU2NoZW1hJzpcbiAgICAgICAgcmV0dXJuICdkZWZpbml0aW9ucyc7XG4gICAgICBjYXNlICdPQVMyUmVzcG9uc2UnOlxuICAgICAgICByZXR1cm4gJ3Jlc3BvbnNlcyc7XG4gICAgICBjYXNlICdPQVMyUGFyYW1ldGVyJzpcbiAgICAgICAgcmV0dXJuICdwYXJhbWV0ZXJzJztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGluY2x1ZGVJbXBsaWNpdERpc2NyaW1pbmF0b3IocG9pbnRlciwgc2NoZW1hcywgY3R4LCB7IHRyYXZlcnNlTm9kZSwgdmlzaXRlZCB9KSB7XG4gICAgY29uc3QgJHJlZiA9IGAjLyR7cG9pbnRlci5qb2luKCcvJyl9YDtcbiAgICBjb25zdCBlcnJvcnMgPSBbXTtcblxuICAgIGZvciAoY29uc3QgW25hbWUsIHNjaGVtYV0gb2YgT2JqZWN0LmVudHJpZXMoc2NoZW1hcyB8fCB7fSkpIHtcbiAgICAgIGlmIChzY2hlbWEuYWxsT2YgJiYgc2NoZW1hLmFsbE9mLmZpbmQoKHMpID0+IHMuJHJlZiA9PT0gJHJlZikpIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdTY2hlbWEgPSB0aGlzLmNvbXBvbmVudHMuc2NoZW1hcyAmJiB0aGlzLmNvbXBvbmVudHMuc2NoZW1hc1tuYW1lXTtcbiAgICAgICAgaWYgKGV4aXN0aW5nU2NoZW1hICYmICFpc0VxdWFsKGV4aXN0aW5nU2NoZW1hLCBzY2hlbWEpKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goY3R4LmNyZWF0ZUVycm9yKFxuICAgICAgICAgICAgYEltcGxpY2l0bHkgbWFwcGVkIGRpc2NyaW1pbmF0b3Igc2NoZW1hIFwiJHtuYW1lfVwiIGNvbmZsaWN0cyB3aXRoIGV4aXN0aW5nIHNjaGVtYS4gU2tpcHBpbmcuYCwgJ2tleScsXG4gICAgICAgICAgKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbXBvbmVudHMuc2NoZW1hcyA9IHRoaXMuY29tcG9uZW50cy5zY2hlbWFzIHx8IHt9O1xuICAgICAgICB0aGlzLmNvbXBvbmVudHMuc2NoZW1hc1tuYW1lXSA9IHNjaGVtYTtcblxuICAgICAgICBjdHgucGF0aFN0YWNrLnB1c2goe1xuICAgICAgICAgIHBhdGg6IGN0eC5wYXRoLFxuICAgICAgICAgIGZpbGU6IGN0eC5maWxlUGF0aCxcbiAgICAgICAgICBkb2N1bWVudDogY3R4LmRvY3VtZW50LFxuICAgICAgICAgIHNvdXJjZTogY3R4LnNvdXJjZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LnBhdGggPSBbJ2NvbXBvbmVudHMnLCAnc2NoZW1hcycsIG5hbWVdO1xuICAgICAgICB0cmF2ZXJzZU5vZGUoc2NoZW1hLCBPcGVuQVBJU2NoZW1hT2JqZWN0LCBjdHgsIHZpc2l0ZWQpO1xuICAgICAgICBjdHgucGF0aCA9IGN0eC5wYXRoU3RhY2sucG9wKCkucGF0aDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG5cbiAgc2F2ZUNvbXBvbmVudChjdHgsIG5vZGUsIG5hbWUsIGNvbXBvbmVudFR5cGUpIHtcbiAgICBsZXQgcmVmO1xuICAgIGlmIChjdHgub3BlbmFwaVZlcnNpb24gPT09IDMpIHtcbiAgICAgIHJlZiA9IGAjL2NvbXBvbmVudHMvJHtjb21wb25lbnRUeXBlfS8ke25hbWV9YDtcblxuICAgICAgaWYgKCF0aGlzLmNvbXBvbmVudHNbY29tcG9uZW50VHlwZV0pIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnRzW2NvbXBvbmVudFR5cGVdID0ge307XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY29tcG9uZW50c1tjb21wb25lbnRUeXBlXVtuYW1lXSA9IG5vZGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN3aXRjaCAoY29tcG9uZW50VHlwZSkge1xuICAgICAgICBjYXNlICdkZWZpbml0aW9ucyc6XG4gICAgICAgICAgcmVmID0gYCMvZGVmaW5pdGlvbnMvJHtuYW1lfWA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3BhcmFtZXRlcnMnOlxuICAgICAgICAgIHJlZiA9IGAjL3BhcmFtZXRlcnMvJHtuYW1lfWA7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3Jlc3BvbnNlcyc6XG4gICAgICAgICAgcmVmID0gYCMvcmVzcG9uc2VzLyR7bmFtZX1gO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMub2FzMmNvbXBvbmVudHNbY29tcG9uZW50VHlwZV0pIHtcbiAgICAgICAgdGhpcy5vYXMyY29tcG9uZW50c1tjb21wb25lbnRUeXBlXSA9IHt9O1xuICAgICAgfVxuICAgICAgdGhpcy5vYXMyY29tcG9uZW50c1tjb21wb25lbnRUeXBlXVtuYW1lXSA9IG5vZGU7XG4gICAgfVxuICAgIHJldHVybiByZWY7XG4gIH1cblxuICBhbnkoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9uRXhpdDogKG5vZGUsIGRlZmluaXRpb24sIGN0eCwgdW5yZXNvbHZlZE5vZGUsIHsgdHJhdmVyc2VOb2RlLCB2aXNpdGVkIH0pID0+IHtcbiAgICAgICAgbGV0IGVycm9ycyA9IFtdO1xuXG4gICAgICAgIGlmIChjdHgub3BlbmFwaVZlcnNpb24gPT09IDNcbiAgICAgICAgICAmJiBub2RlLmRpc2NyaW1pbmF0b3JcbiAgICAgICAgICAmJiAhbm9kZS5vbmVPZlxuICAgICAgICAgICYmICFub2RlLmFueU9mXG4gICAgICAgICAgJiYgIW5vZGUubWFwcGluZykge1xuICAgICAgICAgIGVycm9ycyA9IHRoaXMuaW5jbHVkZUltcGxpY2l0RGlzY3JpbWluYXRvcihcbiAgICAgICAgICAgIGN0eC5wYXRoLFxuICAgICAgICAgICAgY3R4LmRvY3VtZW50LmNvbXBvbmVudHMgJiYgY3R4LmRvY3VtZW50LmNvbXBvbmVudHMuc2NoZW1hcyxcbiAgICAgICAgICAgIGN0eCxcbiAgICAgICAgICAgIHsgdHJhdmVyc2VOb2RlLCB2aXNpdGVkIH0sXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh1bnJlc29sdmVkTm9kZSAmJiBub2RlICE9PSB1bnJlc29sdmVkTm9kZSAmJiBpc1JlZih1bnJlc29sdmVkTm9kZSkpIHtcbiAgICAgICAgICBjb25zdCBjb21wb25lbnRUeXBlID0gdGhpcy5kZWZOYW1lVG9UeXBlKGRlZmluaXRpb24ubmFtZSk7XG5cbiAgICAgICAgICBpZiAoIWNvbXBvbmVudFR5cGUpIHtcbiAgICAgICAgICAgIGRlbGV0ZSB1bnJlc29sdmVkTm9kZS4kcmVmO1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih1bnJlc29sdmVkTm9kZSwgbm9kZSk7XG4gICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5uZXdSZWZOb2Rlcy5oYXModW5yZXNvbHZlZE5vZGUpKSB7XG4gICAgICAgICAgICBjb25zdCB7IG5hbWUsIGVycm9yczogbmFtZUVycm9ycyB9ID0gZ2V0Q29tcG9uZW50TmFtZShcbiAgICAgICAgICAgICAgdW5yZXNvbHZlZE5vZGUuJHJlZiwgdGhpcy5jb21wb25lbnRzLCBjb21wb25lbnRUeXBlLCBub2RlLCBjdHgsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBlcnJvcnMucHVzaCguLi5uYW1lRXJyb3JzKTtcblxuICAgICAgICAgICAgY29uc3QgbmV3UmVmID0gdGhpcy5zYXZlQ29tcG9uZW50KGN0eCwgbm9kZSwgbmFtZSwgY29tcG9uZW50VHlwZSk7XG4gICAgICAgICAgICBpZiAoIW5ld1JlZikge1xuICAgICAgICAgICAgICBkZWxldGUgdW5yZXNvbHZlZE5vZGUuJHJlZjtcbiAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih1bnJlc29sdmVkTm9kZSwgbm9kZSk7XG4gICAgICAgICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIHdlIGNhbid0IHJlcGxhY2Ugbm9kZXMgaW4tcGxhY2UgYXMgbm9uLWlkZW1wb3RlbnRcbiAgICAgICAgICAgIC8vIG5vZGVzIHdpbGwgYmUgdmlzaXRlZCBhZ2FpbiBhbmQgd2lsbCBmYWlsIGJ1bmRsaW5nXG4gICAgICAgICAgICAvLyBzbyB3ZSBzYXZlIGl0IGFuZCByZXBsYWNlIGF0IHRoZSBlbmRcbiAgICAgICAgICAgIHRoaXMubmV3UmVmTm9kZXMuc2V0KHVucmVzb2x2ZWROb2RlLCBuZXdSZWYpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGVycm9ycy5mb3JFYWNoKChlKSA9PiB7XG4gICAgICAgICAgZS5zZXZlcml0eSA9IHRoaXMubmFtZUNvbmZsaWN0c1NldmVyaXR5O1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIXRoaXMubmFtZUNvbmZsaWN0c0VuYWJsZWQpIHtcbiAgICAgICAgICBlcnJvcnMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBPQVMyUm9vdCgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgb25FeGl0OiAobm9kZSwgZGVmaW5pdGlvbiwgY3R4KSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuaWdub3JlRXJyb3JzICYmIGN0eC5yZXN1bHQuc29tZSgoZSkgPT4gZS5zZXZlcml0eSA9PT0gbWVzc2FnZUxldmVscy5FUlJPUikpIHtcbiAgICAgICAgICBjdHguYnVuZGxpbmdSZXN1bHQgPSBudWxsO1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBbdW5yZXNvbHZlZE5vZGUsIG5ld1JlZl0gb2YgdGhpcy5uZXdSZWZOb2Rlcy5lbnRyaWVzKCkpIHtcbiAgICAgICAgICB1bnJlc29sdmVkTm9kZS4kcmVmID0gbmV3UmVmO1xuICAgICAgICB9XG5cbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5vYXMyY29tcG9uZW50cykuZm9yRWFjaCgoY29tcG9uZW50KSA9PiB7XG4gICAgICAgICAgbm9kZVtjb21wb25lbnRdID0gbm9kZVtjb21wb25lbnRdID8gbm9kZVtjb21wb25lbnRdIDoge307XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihub2RlW2NvbXBvbmVudF0sIHRoaXMub2FzMmNvbXBvbmVudHNbY29tcG9uZW50XSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN0eC5idW5kbGluZ1Jlc3VsdCA9IG5vZGU7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgT3BlbkFQSVJvb3QoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9uRXhpdDogKG5vZGUsIGRlZmluaXRpb24sIGN0eCkgPT4ge1xuICAgICAgICBpZiAoIW5vZGUuY29tcG9uZW50cykge1xuICAgICAgICAgIG5vZGUuY29tcG9uZW50cyA9IHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5pZ25vcmVFcnJvcnMgJiYgY3R4LnJlc3VsdC5zb21lKChlKSA9PiBlLnNldmVyaXR5ID09PSBtZXNzYWdlTGV2ZWxzLkVSUk9SKSkge1xuICAgICAgICAgIGN0eC5idW5kbGluZ1Jlc3VsdCA9IG51bGw7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IFt1bnJlc29sdmVkTm9kZSwgbmV3UmVmXSBvZiB0aGlzLm5ld1JlZk5vZGVzLmVudHJpZXMoKSkge1xuICAgICAgICAgIGlmICh1bnJlc29sdmVkTm9kZVtNQVBQSU5HX0RBVEFfS0VZXSkgeyAvLyBGSVhNRTogdG9vIGhhY2tcbiAgICAgICAgICAgIGNvbnN0IHsgbWFwcGluZywga2V5IH0gPSB1bnJlc29sdmVkTm9kZVtNQVBQSU5HX0RBVEFfS0VZXTtcbiAgICAgICAgICAgIG1hcHBpbmdba2V5XSA9IG5ld1JlZjtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdW5yZXNvbHZlZE5vZGUuJHJlZiA9IG5ld1JlZjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmNvbXBvbmVudHMpLmZvckVhY2goKGNvbXBvbmVudCkgPT4ge1xuICAgICAgICAgIG5vZGUuY29tcG9uZW50c1tjb21wb25lbnRdID0gbm9kZS5jb21wb25lbnRzW2NvbXBvbmVudF0gPyBub2RlLmNvbXBvbmVudHNbY29tcG9uZW50XSA6IHt9O1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24obm9kZS5jb21wb25lbnRzW2NvbXBvbmVudF0sIHRoaXMuY29tcG9uZW50c1tjb21wb25lbnRdKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY3R4LmJ1bmRsaW5nUmVzdWx0ID0gbm9kZTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBCdW5kbGVyO1xuIl19